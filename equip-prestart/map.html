<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Equipment Map</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #fff; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 16px; }
    h1 { margin: 0 0 10px 0; font-size: 22px; }
    .sub { margin: 0 0 14px 0; color: #444; }
    label { display:block; margin-top: 10px; font-weight: 650; }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      font-size: 16px;
      box-sizing: border-box;
    }
    button { cursor: pointer; border: 0; }
    button.primary { background: #111; color: #fff; }
    button.secondary { background: #fff; color: #111; border: 1px solid #cfcfcf; }
    .status { margin-top: 12px; white-space: pre-wrap; color: #333; }
    #map { height: 70vh; border-radius: 14px; border: 1px solid #ddd; background: #f3f3f3; }
    .topbar { display:flex; gap: 10px; flex-wrap: wrap; margin: 12px 0 12px; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; border: 1px solid #ddd; font-size: 13px; color: #333; }
    .hidden { display: none !important; }
    @media (max-width: 820px) { #map { height: 64vh; } }
  </style>
</head>
<body>
  <div class="wrap">

    <div id="loginCard" class="card">
      <h1>Equipment Map</h1>
      <p class="sub">Enter the 4-digit passcode to view equipment locations.</p>

      <form id="loginForm">
        <label>Passcode</label>
        <input id="passcode" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="4 digits" required />
        <button class="primary" type="submit">View Map</button>
        <div class="status" id="loginStatus"></div>
      </form>
    </div>

    <div id="mapCard" class="card hidden">
      <div class="topbar">
        <span class="pill" id="countPill">Pins: 0</span>
        <button class="secondary" id="refreshBtn" type="button">Refresh</button>
        <button class="secondary" id="logoutBtn" type="button">Lock Map</button>
      </div>

      <div id="map"></div>
      <div class="status" id="mapStatus"></div>
    </div>

  </div>

  <script>
    const loginCard = document.getElementById("loginCard");
    const mapCard = document.getElementById("mapCard");
    const loginForm = document.getElementById("loginForm");
    const passcodeEl = document.getElementById("passcode");
    const loginStatus = document.getElementById("loginStatus");

    const refreshBtn = document.getElementById("refreshBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const mapStatus = document.getElementById("mapStatus");
    const countPill = document.getElementById("countPill");

    let map;
    let markers = [];
    let googleReady = false;

    const showLogin = () => {
      loginCard.classList.remove("hidden");
      mapCard.classList.add("hidden");
      loginStatus.textContent = "";
      passcodeEl.value = "";
      passcodeEl.focus();
    };

    const showMapShell = () => {
      loginCard.classList.add("hidden");
      mapCard.classList.remove("hidden");
    };

    const escapeHtml = (s) =>
      String(s || "").replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[c]));

    const formatWhen = (iso) => {
      if (!iso) return "";
      const d = new Date(iso);
      return d.toLocaleString();
    };

    const postLogin = async (passcode) => {
      const r = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ passcode })
      });
      const out = await r.json();
      return { status: r.status, out };
    };

    const doLogout = async () => {
      try { await fetch("/api/logout"); } catch (e) {}
    };

    const fetchPins = async () => {
      const r = await fetch("/api/map-data");
      const out = await r.json();
      return { status: r.status, out };
    };

    const clearMarkers = () => {
      for (const m of markers) m.setMap(null);
      markers = [];
    };

    const initMapIfNeeded = () => {
      if (map) return;

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.33, lng: -119.29 }, // default center
        zoom: 9,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true
      });
    };

    const renderPins = (pins) => {
      clearMarkers();
      countPill.textContent = `Pins: ${pins.length}`;

      if (!pins.length) {
        mapStatus.textContent = "No GPS pins found yet.";
        return;
      }

      const bounds = new google.maps.LatLngBounds();

      for (const p of pins) {
        const pos = { lat: p.lat, lng: p.lon };
        bounds.extend(pos);

        const marker = new google.maps.Marker({
          position: pos,
          map,
          title: `${p.equipment || "Unknown"}`
        });

        const info = new google.maps.InfoWindow({
          content: `
            <div style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size: 14px;">
              <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(p.equipment || "Unknown")}</div>
              <div><b>Project:</b> ${escapeHtml(p.project || "")}</div>
              <div><b>Time:</b> ${escapeHtml(formatWhen(p.createdTime))}</div>
              <div><b>Accuracy:</b> ${p.acc != null ? Math.round(p.acc) + " m" : ""}</div>
              <div style="margin-top:8px;">
                <a target="_blank" rel="noreferrer"
                   href="https://www.google.com/maps?q=${p.lat},${p.lon}">
                   Open in Google Maps
                </a>
              </div>
            </div>
          `
        });

        marker.addListener("click", () => info.open({ anchor: marker, map }));
        markers.push(marker);
      }

      map.fitBounds(bounds);
      mapStatus.textContent = "";
    };

    const loadPinsFlow = async () => {
      mapStatus.textContent = "Loading pins…";
      const { status, out } = await fetchPins();

      if (status === 401) {
        showLogin();
        return;
      }

      if (!out.ok) {
        mapStatus.textContent = "Error:\n" + JSON.stringify(out, null, 2);
        return;
      }

      if (!googleReady) {
        mapStatus.textContent = "Google Maps is still loading…";
        return;
      }

      initMapIfNeeded();
      renderPins(out.pins || []);
    };

    // Called by Google Maps script callback
    window.__bootMap = async () => {
      googleReady = true;
      // If the user is already authorized, show map and load pins.
      showMapShell();
      await loadPinsFlow();
    };

    // Login form submit
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginStatus.textContent = "Checking…";

      const code = (passcodeEl.value || "").trim();
      const { status, out } = await postLogin(code);

      if (status !== 200 || !out.ok) {
        loginStatus.textContent = "Invalid passcode.";
        return;
      }

      loginStatus.textContent = "";
      showMapShell();
      await loadPinsFlow();
    });

    refreshBtn.addEventListener("click", async () => {
      await loadPinsFlow();
    });

    logoutBtn.addEventListener("click", async () => {
      await doLogout();
      showLogin();
    });

    // Load Google Maps JS dynamically using /api/config
    async function loadGoogleMapsScript() {
      mapStatus.textContent = "Loading Google Maps…";

      const r = await fetch("/api/config");
      const cfg = await r.json();

      if (!cfg.ok || !cfg.googleMapsKey) {
        mapStatus.textContent = "Missing Google Maps API key.";
        showMapShell();
        return;
      }

      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(cfg.googleMapsKey)}&callback=__bootMap`;
      s.async = true;
      s.defer = true;

      s.onerror = () => {
        showMapShell();
        mapStatus.textContent = "Google Maps failed to load. Check API key restrictions in Google Cloud.";
      };

      document.head.appendChild(s);
    }

    // Boot: try to show map if already authed; otherwise show login.
    (async () => {
      showMapShell();
      await loadPinsFlow(); // if 401, will switch to login
      await loadGoogleMapsScript();
    })();
  </script>
</body>
</html>
