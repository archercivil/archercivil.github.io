<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daily Pre-Start Inspection</title>

  <!-- Favicon: upload same filename used in Admin-Expense app -->
  <link rel="icon" href="/favicon.ico" />

  <style>
    :root{
      --bg:#0b0f17;
      --card:#0f1624;
      --card2:#0c1320;
      --text:#e8eefc;
      --muted:#a9b6d1;
      --line:rgba(255,255,255,0.10);
      --line2:rgba(255,255,255,0.14);
      --accent:#3b82f6;
      --accent2:#60a5fa;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --shadow: 0 10px 40px rgba(0,0,0,0.35);
      --radius: 18px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 10% 0%, rgba(59,130,246,0.18), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(96,165,250,0.14), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .logo{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }

    /* Upload Archer logo with same filename used in Admin-Expense app */
    .logo img{
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 6px;
    }

    .titleBlock{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 0;
    }
    .title{
      margin:0;
      font-size: 22px;
      letter-spacing: 0.2px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.25;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .cardBody{
      padding: 16px;
    }

    .section{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--line);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid2{ grid-template-columns: 1fr; }
      .wrap{ padding-bottom: 28px; }
    }

    label{
      display:block;
      margin: 0 0 6px;
      font-weight: 650;
      font-size: 13px;
      color: rgba(232,238,252,0.92);
    }

    .field{
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--line2);
      border-radius: 14px;
      padding: 12px;
      color: var(--text);
      width: 100%;
      font-size: 16px;
      outline: none;
    }

    .field::placeholder{ color: rgba(169,182,209,0.75); }

    textarea.field{ min-height: 92px; resize: vertical; }

    .help{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.25;
    }

    .pillRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 10px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      font-size: 13px;
      color: var(--text);
      user-select: none;
    }

    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--muted);
    }
    .dot.ok{ background: var(--ok); }
    .dot.warn{ background: var(--warn); }
    .dot.bad{ background: var(--danger); }

    .actions{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 14px;
    }

    .btn{
      width: 100%;
      border: 0;
      border-radius: 14px;
      padding: 14px 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }
    .btnPrimary{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: #07101f;
    }
    .btnGhost{
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border: 1px solid var(--line);
      font-weight: 650;
    }

    .status{
      margin-top: 12px;
      white-space: pre-wrap;
      font-size: 13px;
      color: rgba(232,238,252,0.95);
    }

    .req{
      color: rgba(232,238,252,0.9);
      font-weight: 750;
    }
    .req::after{
      content:" *";
      color: var(--warn);
      font-weight: 900;
    }

    /* iOS / mobile consistency + date/time fixes */
    input, select, textarea{
      -webkit-text-size-adjust: 100%;
    }

    /* Normalize date/time to look like regular inputs */
    input[type="date"],
    input[type="time"],
    input[type="datetime-local"]{
      -webkit-appearance: none;
      appearance: none;
      text-align: left;
      padding-left: 12px;
      padding-right: 12px;
    }

    /* Prevent iOS from centering content in certain cases */
    input[type="date"]::-webkit-date-and-time-value,
    input[type="datetime-local"]::-webkit-date-and-time-value{
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <!-- Upload Archer logo with same filename used in Admin-Expense app -->
        <img src="/archer-logo.png" alt="Archer Civil" onerror="this.style.display='none';" />
      </div>
      <div class="titleBlock">
        <h1 class="title">Daily Pre-Start Inspection</h1>
        <p class="subtitle">GPS auto-captures when available. If not, a mappable address is required.</p>
      </div>
    </div>

    <div class="card">
      <div class="cardBody">
        <form id="f" autocomplete="on">
          <div class="grid2">
            <div>
              <label class="req">Date &amp; Time</label>
              <input class="field" name="dateTime" type="datetime-local" required />
              <div class="help">Defaults to current time. Notion also records Created Time.</div>
            </div>
            <div>
              <label class="req">Employee Name</label>
              <input class="field" name="employeeName" type="text" placeholder="First Last" required />
            </div>
          </div>

          <div class="section">
            <div class="grid2">
              <div>
                <label class="req">Project</label>
                <select class="field" name="project" required>
                  <option value="">Select…</option>
                  <option>Not Listed Below</option>
                  <option>25020 G&amp;J Heavy Haul Yard</option>
                  <option>25021 Crystal Cave Repairs</option>
                  <option>25022 Hanford 12th &amp; Hume</option>
                  <option>25023 Henry Miller Ditch Lining</option>
                  <option>25027 Los Banos WWTP</option>
                  <option>25028 Tulare K Street</option>
                  <option>25029 Los Banos Basin Capture</option>
                  <option>25033 Madera Levee Patrol</option>
                </select>
              </div>

              <div>
                <label class="req">Equipment</label>
                <select class="field" name="equipment" required>
                  <option value="">Select…</option>
                  <option>Not Listed Below</option>
                  <option>1055-1</option><option>1055-2</option><option>1055P-1</option>
                  <option>10R-1</option><option>10R-2</option><option>10F-1</option>
                  <option>12000-1</option><option>12000-2</option><option>12000-3</option><option>12000-4</option>
                  <option>12-1</option><option>150-1</option><option>15R-1</option><option>22R-1</option><option>289-1</option>
                </select>
              </div>
            </div>

            <div class="grid2" style="margin-top:12px;">
              <div>
                <label>Hour Meter</label>
                <input class="field" name="hourMeter" type="number" min="0" step="1" placeholder="0" />
              </div>
              <div>
                <label>Manager Comment (record title)</label>
                <input class="field" name="managerComment" type="text" placeholder="AM check / New submission / short note" />
              </div>
            </div>
          </div>

          <div class="section">
            <div class="pillRow">
              <span class="pill" id="gpsPill">
                <span class="dot" id="gpsDot"></span>
                <span id="gpsText">GPS: attempting…</span>
              </span>
              <button class="btn btnGhost" type="button" id="retryGpsBtn">Retry GPS</button>
              <button class="btn btnGhost" type="button" id="clearGpsBtn">Clear GPS</button>
            </div>
            <div class="help">If GPS fails, enter a full address below (mappable by Google Maps).</div>

            <!-- Hidden GPS fields -->
            <input type="hidden" name="gpsLat" />
            <input type="hidden" name="gpsLon" />
            <input type="hidden" name="gpsAcc" />

            <div style="margin-top:12px;">
              <label id="addressLabel">Address for Map Pin</label>
              <input class="field" id="addressField" name="locationText" type="text"
                     placeholder="123 Main St, City, CA 93291" />
              <div class="help" id="addressHelp">Required only if GPS is not captured.</div>
            </div>

            <div style="margin-top:12px;">
              <label>Describe Location</label>
              <textarea class="field" name="describeLocation" rows="3" placeholder="Gate, stationing, north side of yard, etc."></textarea>
            </div>
          </div>

          <div class="section">
            <label class="req">Defects Found?</label>
            <select class="field" name="defectsFound" multiple size="3" required>
              <option>No. Safe to Operate.</option>
              <option>Yes. Safe to Operate.</option>
              <option>Yes. DO NOT OPERATE.</option>
            </select>
            <div class="help">You can select more than one if needed.</div>

            <div style="margin-top:12px;">
              <label>Describe Equipment</label>
              <textarea class="field" name="describeEquipment" rows="3" placeholder="Attachments, configuration, observations."></textarea>
            </div>

            <div style="margin-top:12px;">
              <label>Describe Defect</label>
              <textarea class="field" name="describeDefect" rows="4" placeholder="Describe any defect or issue."></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn btnPrimary" type="submit">Submit</button>
          </div>

          <div class="status" id="status"></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const f = document.getElementById("f");
    const statusEl = document.getElementById("status");

    const gpsPill = document.getElementById("gpsPill");
    const gpsText = document.getElementById("gpsText");
    const gpsDot = document.getElementById("gpsDot");

    const retryGpsBtn = document.getElementById("retryGpsBtn");
    const clearGpsBtn = document.getElementById("clearGpsBtn");

    const addressField = document.getElementById("addressField");
    const addressLabel = document.getElementById("addressLabel");
    const addressHelp = document.getElementById("addressHelp");

    // Date/time default to now (datetime-local)
    const dt = f.elements.dateTime;
    const pad = (n) => String(n).padStart(2, "0");
    const setNow = () => {
      const now = new Date();
      dt.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
    };
    setNow();

    const setGpsUi = (state, msg) => {
      // state: "ok" | "warn" | "bad"
      gpsDot.className = "dot " + (state || "");
      gpsText.textContent = msg || "";
    };

    const hasGps = () => {
      const lat = (f.elements.gpsLat.value || "").trim();
      const lon = (f.elements.gpsLon.value || "").trim();
      return lat !== "" && lon !== "";
    };

    const requireAddress = (required) => {
      if (required) {
        addressLabel.classList.add("req");
        addressHelp.textContent = "Required because GPS is not captured.";
        addressField.required = true;
      } else {
        addressLabel.classList.remove("req");
        addressHelp.textContent = "Required only if GPS is not captured.";
        addressField.required = false;
      }
    };

    const clearGps = () => {
      f.elements.gpsLat.value = "";
      f.elements.gpsLon.value = "";
      f.elements.gpsAcc.value = "";
      setGpsUi("bad", "GPS: not captured");
      requireAddress(true);
    };

    const captureGps = () => {
      statusEl.textContent = "";
      setGpsUi("warn", "GPS: requesting…");

      if (!navigator.geolocation) {
        setGpsUi("bad", "GPS: not supported");
        requireAddress(true);
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          f.elements.gpsLat.value = String(latitude);
          f.elements.gpsLon.value = String(longitude);
          f.elements.gpsAcc.value = String(accuracy);

          setGpsUi("ok", `GPS: captured (±${Math.round(accuracy)} m)`);
          requireAddress(false);
        },
        (err) => {
          clearGps();
          // Make the reason visible but keep it short
          statusEl.textContent = "GPS not available. Enter an address for the map pin.\n" + err.message;
        },
        { enableHighAccuracy: true, timeout: 12000, maximumAge: 0 }
      );
    };

    // Auto-capture GPS on load (what you requested)
    // Small delay helps iOS render before location prompt
    window.addEventListener("load", () => {
      setTimeout(() => captureGps(), 350);
    });

    retryGpsBtn.addEventListener("click", () => captureGps());
    clearGpsBtn.addEventListener("click", () => {
      clearGps();
      addressField.focus();
    });

    // Keep address requirement in sync if user clears GPS manually
    addressField.addEventListener("input", () => {
      // no-op, but keeps form validation friendly
    });

    // Helpers
    const sanitize = (v) => (v == null ? "" : String(v)).trim();
    const getMultiSelect = (selectEl) =>
      Array.from(selectEl.selectedOptions).map((o) => o.value);

    const looksMappable = (addr) => {
      // Lightweight check: contains at least one digit and at least 2 words
      const a = sanitize(addr);
      if (a.length < 8) return false;
      const hasDigit = /\d/.test(a);
      const words = a.split(/\s+/).filter(Boolean);
      return hasDigit && words.length >= 2;
    };

    const buildPayload = () => ({
      employeeName: sanitize(f.elements.employeeName.value),
      project: f.elements.project.value,
      equipment: f.elements.equipment.value,
      hourMeter: f.elements.hourMeter.value,
      managerComment: sanitize(f.elements.managerComment.value),

      // Address for pin (your "Location" field in Notion)
      locationText: sanitize(f.elements.locationText.value),
      describeLocation: sanitize(f.elements.describeLocation.value),

      gpsLat: f.elements.gpsLat.value,
      gpsLon: f.elements.gpsLon.value,
      gpsAcc: f.elements.gpsAcc.value,

      defectsFound: getMultiSelect(f.elements.defectsFound),
      describeEquipment: sanitize(f.elements.describeEquipment.value),
      describeDefect: sanitize(f.elements.describeDefect.value),

      dateTimeLocal: f.elements.dateTime.value
    });

    const validateClient = (p) => {
      const missing = [];
      if (!p.employeeName) missing.push("Employee Name");
      if (!p.project) missing.push("Project");
      if (!p.equipment) missing.push("Equipment");
      if (!Array.isArray(p.defectsFound) || p.defectsFound.length === 0) missing.push("Defects Found?");
      return missing;
    };

    f.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "Submitting…";

      const payload = buildPayload();

      // Base required fields
      const missing = validateClient(payload);
      if (missing.length) {
        statusEl.textContent = "Missing required fields:\n- " + missing.join("\n- ");
        return;
      }

      // GPS or address requirement
      const gpsOk = hasGps();
      if (!gpsOk) {
        // Demand an address usable by Google Maps for the pin
        if (!payload.locationText) {
          statusEl.textContent = "GPS not captured. Address for Map Pin is required.";
          addressField.focus();
          return;
        }
        if (!looksMappable(payload.locationText)) {
          statusEl.textContent = "Enter a full mappable address (example: 123 Main St, City, CA).";
          addressField.focus();
          return;
        }
      }

      try {
        const r = await fetch("/api/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const out = await r.json();

        if (!r.ok || !out.ok) {
          statusEl.textContent = "Error:\n" + JSON.stringify(out, null, 2);
          return;
        }

        statusEl.textContent =
          "Submitted ✓\n" +
          "Notion Page ID: " + out.id +
          (out.doNotOperate ? "\n\nDO NOT OPERATE flagged." : "");

        // Reset
        f.reset();
        setNow();
        setGpsUi("warn", "GPS: attempting…");

        // Re-attempt GPS automatically for next submission
        setTimeout(() => captureGps(), 350);

        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      } catch (err) {
        statusEl.textContent = "Network error:\n" + String(err);
      }
    });
  </script>
</body>
</html>